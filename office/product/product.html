<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>จัดการสินค้า • SneakerHub Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{
  --bg:#f7f8fa; --card:#fff; --text:#111; --muted:#6b7280;
  --line:#e5e7eb; --accent:#1d4ed8; --danger:#d32f2f; --ok:#16a34a;
  --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.06);
}
*{box-sizing:border-box} body{font-family:ui-sans-serif,system-ui,"Prompt",Arial;color:var(--text);background:var(--bg);margin:0}
.container{max-width:1200px;margin:24px auto;padding:0 18px}
h1{margin:8px 0 18px}
.toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.toolbar .left{display:flex;gap:10px;flex:1;align-items:center}
.toolbar .right{display:flex;gap:10px}
.search{position:relative;min-width:280px;flex:1}
.search input{width:100%;padding:10px 36px 10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
.search i{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--muted)}
select, input[type="number"]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.btn{padding:10px 14px;border-radius:10px;border:1px solid transparent;background:var(--accent);color:#fff;cursor:pointer}
.btn:hover{filter:brightness(.95)}
.btn-outline{padding:9px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.btn-outline:hover{border-color:var(--accent)}
.btn-danger{background:var(--danger);color:#fff}

.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.card.pad{padding:14px}

.table-wrap{margin-top:14px;overflow:auto;border-radius:12px;border:1px solid var(--line);background:#fff}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);font-weight:600;text-align:center;padding:10px}
tbody td{border-bottom:1px solid var(--line);padding:10px;text-align:center;vertical-align:middle}
tbody tr:hover{background:#fafafa}
td.left{text-align:left}
.img{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);display:inline-block}
.badge.ok{color:var(--ok);border-color:rgba(22,163,74,.3);background:#ecfdf5}
.badge.no{color:#b91c1c;border-color:#fee2e2;background:#fff1f2}
.price{font-weight:700}
.strike{text-decoration:line-through;color:var(--muted);font-size:13px}
.mini{color:var(--muted);font-size:12px}
.icon-btn{border:1px solid var(--line);background:#fff;border-radius:10px;width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.icon-btn:hover{border-color:var(--accent)}
.star{color:#f59e0b}
.actions{display:flex;gap:8px;justify-content:center}
.qty-editor{display:inline-flex;align-items:center;gap:6px}
.qty-editor input{width:80px;text-align:center}

.pager{display:flex;justify-content:space-between;align-items:center;margin:14px 0}
.pager .info{color:var(--muted);font-size:14px}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modal.open{display:flex}
.modal .panel{background:#fff;border-radius:16px;max-width:720px;width:100%;box-shadow:var(--shadow)}
.modal .head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
.modal .body{padding:16px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid .full{grid-column:1/-1}
.input{display:flex;flex-direction:column;gap:6px}
.input input,.input select{padding:10px;border:1px solid var(--line);border-radius:10px}
.preview{width:120px;height:120px;object-fit:cover;border:1px solid var(--line);border-radius:12px;background:#f3f4f6}
.help{font-size:12px;color:var(--muted)}
@media (max-width:720px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <h1>จัดการสินค้า</h1>

  <!-- Toolbar -->
  <div class="card pad toolbar">
    <div class="left">
      <div class="search">
        <input id="q" type="search" placeholder="ค้นหา: รหัส/ชื่อ/แบรนด์/หมวดหมู่...">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <select id="filter-category">
        <option value="">หมวดหมู่ทั้งหมด</option>
      </select>
      <select id="filter-brand">
        <option value="">แบรนด์ทั้งหมด</option>
      </select>
      <select id="filter-gender">
        <option value="">เพศทั้งหมด</option>
        <option value="men">ผู้ชาย</option>
        <option value="women">ผู้หญิง</option>
        <option value="unisex">Unisex</option>
      </select>
      <select id="filter-recommended">
        <option value="">ทั้งหมด</option>
        <option value="true">เฉพาะสินค้าแนะนำ</option>
        <option value="false">ยกเว้นสินค้าแนะนำ</option>
      </select>
    </div>
    <div class="right">
      <button class="btn-outline" id="refreshBtn"><i class="fa-solid fa-rotate"></i> รีเฟรช</button>
      <button class="btn" id="openAdd"><i class="fa-solid fa-plus"></i> เพิ่มสินค้า</button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>รูป</th>
          <th>รหัส</th>
          <th style="min-width:240px">ชื่อสินค้า</th>
          <th>ราคา</th>
          <th>จำนวน</th>
          <th>แนะนำ</th>
          <th style="min-width:180px">จัดการ</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Pager -->
  <div class="pager">
    <div class="info" id="info">กำลังโหลด…</div>
    <div class="right">
      <button class="btn-outline" id="prevBtn"><i class="fa-solid fa-chevron-left"></i></button>
      <button class="btn-outline" id="nextBtn"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="head">
      <strong id="modalTitle">เพิ่มสินค้า</strong>
      <button class="icon-btn" id="closeModal"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="body">
      <form id="formProduct" class="grid">
        <div class="input">
          <label>รหัสสินค้า (SKU)</label>
          <input name="product_id" required placeholder="เช่น SKU-001">
        </div>
        <div class="input">
          <label>ชื่อสินค้า</label>
          <input name="name" required>
        </div>

        <div class="input">
          <label>แบรนด์</label>
          <input name="brand" placeholder="เช่น Nike">
        </div>
        <div class="input">
          <label>หมวดหมู่</label>
          <input name="category" placeholder="เช่น Running">
        </div>

        <div class="input">
          <label>เพศ</label>
          <select name="gender">
            <option value="">(ไม่ระบุ)</option>
            <option value="men">ผู้ชาย</option>
            <option value="women">ผู้หญิง</option>
            <option value="unisex">Unisex</option>
          </select>
        </div>
        <div class="input">
          <label>จำนวน</label>
          <input name="quantity" type="number" min="0" required value="0">
        </div>

        <div class="input">
          <label>ราคาทุน</label>
          <input name="cost_price" type="number" step="0.01" min="0" required value="0">
        </div>
        <div class="input">
          <label>ราคาขาย</label>
          <input name="sell_price" type="number" step="0.01" min="0" required value="0">
        </div>

        <div class="input">
          <label>ราคาป้าย (เดิม)</label>
          <input name="original_price" type="number" step="0.01" min="0" placeholder="ไม่บังคับ">
        </div>
        <div class="input">
          <label>สถานะสินค้าแนะนำ</label>
          <select name="recommended">
            <option value="false">ไม่แนะนำ</option>
            <option value="true">แนะนำ</option>
          </select>
        </div>

        <div class="input full">
          <label>รูปภาพสินค้า (อัปโหลดหรือไม่ก็ได้)</label>
          <div style="display:flex;gap:12px;align-items:center">
            <img id="preview" class="preview" alt="">
            <div>
              <input name="image" type="file" accept="image/*">
              <div class="help">ถ้าไม่อัปโหลด ระบบจะคงรูปเดิมไว้</div>
            </div>
          </div>
        </div>

        <div class="full" style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px">
          <button type="button" class="btn-outline" id="cancelModal">ยกเลิก</button>
          <button type="submit" class="btn" id="submitBtn">บันทึก</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="/account/env/env.js"></script>
<script>
const API = ENV.api; // ex. http://localhost:5555
const THB = n => `฿${Number(n||0).toLocaleString("th-TH")}`;
const qs = sel => document.querySelector(sel);

let state = {
  page: 1,
  limit: 12,
  q: "",
  category: "",
  brand: "",
  gender: "",
  recommended: "",
  data: [],
};

const els = {
  tbody: qs("#tbody"),
  info: qs("#info"),
  prevBtn: qs("#prevBtn"),
  nextBtn: qs("#nextBtn"),
  q: qs("#q"),
  fCat: qs("#filter-category"),
  fBrand: qs("#filter-brand"),
  fGender: qs("#filter-gender"),
  fRec: qs("#filter-recommended"),
  refresh: qs("#refreshBtn"),
  openAdd: qs("#openAdd"),
  modal: qs("#modal"),
  modalTitle: qs("#modalTitle"),
  form: qs("#formProduct"),
  cancelModal: qs("#cancelModal"),
  closeModal: qs("#closeModal"),
  preview: qs("#preview"),
  submitBtn: qs("#submitBtn"),
};

function openModal(title="เพิ่มสินค้า", data=null){
  els.modalTitle.textContent = title;
  els.form.reset();
  els.preview.src = "";
  els.preview.style.display = "none";
  els.form.dataset.mode = data ? "edit" : "add";
  els.form.dataset.originalId = data?.product_id || "";

  if (data){
    // ใส่ค่าในฟอร์ม (บางฟิลด์อาจไม่มีจาก API เดิมได้ เผื่อไว้ด้วย ??)
    els.form.product_id.value = data.product_id ?? "";
    els.form.name.value = data.name ?? "";
    els.form.brand.value = data.brand ?? "";
    els.form.category.value = data.category ?? "";
    els.form.gender.value = data.gender ?? "";
    els.form.quantity.value = data.quantity ?? 0;
    els.form.cost_price.value = data.cost_price ?? 0;
    els.form.sell_price.value = data.sell_price ?? 0;
    els.form.original_price.value = data.original_price ?? "";
    els.form.recommended.value = String(!!data.recommended);

    if (data.image){
      els.preview.src = API + data.image;
      els.preview.style.display = "block";
    }
  }
  els.modal.classList.add("open");
}
function closeModal(){ els.modal.classList.remove("open"); }

els.openAdd.addEventListener("click", ()=> openModal("เพิ่มสินค้าใหม่", null));
els.cancelModal.addEventListener("click", closeModal);
els.closeModal.addEventListener("click", closeModal);

els.form.image?.addEventListener("change", e=>{
  const f = e.target.files?.[0];
  if (!f){ els.preview.style.display="none"; return; }
  const url = URL.createObjectURL(f);
  els.preview.src = url; els.preview.style.display="block";
});

// โหลดรายการ (ใช้ /product ที่คุณมีอยู่)
async function loadProducts(){
  els.info.textContent = "กำลังโหลด…";
  els.tbody.innerHTML = "";

  try{
    const res = await fetch(`${API}/product`);
    const json = await res.json();
    let items = Array.isArray(json.products) ? json.products : [];

    // filter ฝั่งหน้า (ถ้ายังไม่ทำใน API)
    const q = state.q.toLowerCase();
    if (q){
      items = items.filter(x =>
        (x.product_id||"").toLowerCase().includes(q) ||
        (x.name||"").toLowerCase().includes(q) ||
        (x.brand||"").toLowerCase().includes(q) ||
        (x.category||"").toLowerCase().includes(q)
      );
    }
    if (state.category) items = items.filter(x => (x.category||"") === state.category);
    if (state.brand)    items = items.filter(x => (x.brand||"") === state.brand);
    if (state.gender)   items = items.filter(x => (x.gender||"") === state.gender);
    if (state.recommended !== ""){
      const want = state.recommended === "true";
      items = items.filter(x => !!x.recommended === want);
    }

    // เติมค่า filter (category/brand) จากข้อมูลที่มี
    fillFilterDistinct(items);

    // pagination ฝั่งหน้า
    state.total = items.length;
    const start = (state.page-1)*state.limit;
    const pageItems = items.slice(start, start + state.limit);

    pageItems.forEach(p => els.tbody.insertAdjacentHTML("beforeend", rowHTML(p)));
    els.info.textContent = `${Math.min(state.page*state.limit, state.total)} / ${state.total} รายการ`;
    els.prevBtn.disabled = state.page<=1;
    els.nextBtn.disabled = state.page*state.limit >= state.total;

    // bind ปุ่มในตาราง
    bindTableEvents();
  }catch(err){
    console.error(err);
    els.info.textContent = "โหลดไม่สำเร็จ";
    alert("โหลดสินค้าล้มเหลว");
  }
}
function rowHTML(p){
  const inStock = (Number(p.quantity||0) > 0);
  const price = Number(p.sell_price||0);
  const original = p.original_price ? Number(p.original_price) : 0;

  return `
  <tr data-id="${p.product_id}">
    <td><img class="img" src="${p.image ? (API + p.image) : '/img/products/box.png'}" onerror="this.src='/img/products/box.png'" alt=""></td>
    <td>
      <div>${p.product_id||""}</div>
      <div class="mini">${p.brand||"-"} • ${p.category||"-"} ${p.gender?("• "+p.gender):""}</div>
    </td>
    <td class="left">
      <div>${p.name||"-"}</div>
      <div class="mini">${inStock?'<span class="badge ok">มีสต็อก</span>':'<span class="badge no">หมดสต็อก</span>'}</div>
    </td>
    <td>
      <div class="price">${THB(price)}</div>
      ${original>price? `<div class="strike">${THB(original)}</div>` : ""}
    </td>
    <td>
      <div class="qty-editor">
        <button class="icon-btn dec"><i class="fa-solid fa-minus"></i></button>
        <input class="qty" type="number" min="0" value="${p.quantity||0}">
        <button class="icon-btn inc"><i class="fa-solid fa-plus"></i></button>
        <button class="icon-btn save"><i class="fa-solid fa-floppy-disk"></i></button>
      </div>
    </td>
    <td>
      <button class="icon-btn recommend" title="${p.recommended?'ยกเลิกแนะนำ':'ตั้งแนะนำ'}">
        <i class="fa${p.recommended?'-solid':'-regular'} fa-star star"></i>
      </button>
    </td>
    <td>
      <div class="actions">
        <button class="btn-outline edit"><i class="fa-regular fa-pen-to-square"></i> แก้ไข</button>
        <button class="btn-outline imgupdate"><i class="fa-regular fa-image"></i> เปลี่ยนรูป</button>
        <button class="btn-danger delete"><i class="fa-regular fa-trash-can"></i> ลบ</button>
      </div>
    </td>
  </tr>`;
}

function bindTableEvents(){
  // เพิ่ม/ลด และเซฟจำนวน (PATCH /product/:id/quantity)
  els.tbody.querySelectorAll("tr").forEach(tr=>{
    const id = tr.dataset.id;
    const qtyInput = tr.querySelector(".qty");
    tr.querySelector(".inc").addEventListener("click", ()=> qtyInput.value = Number(qtyInput.value||0)+1);
    tr.querySelector(".dec").addEventListener("click", ()=> qtyInput.value = Math.max(0, Number(qtyInput.value||0)-1));
    tr.querySelector(".save").addEventListener("click", async ()=>{
      await updateQuantity(id, Number(qtyInput.value||0));
      loadProducts();
    });

    tr.querySelector(".recommend").addEventListener("click", async ()=>{
      const nowActive = tr.querySelector(".fa-star").classList.contains("fa-regular"); // ถ้า regular -> จะตั้งให้เป็นแนะนำ
      await toggleRecommended(id, nowActive);
      loadProducts();
    });

    tr.querySelector(".edit").addEventListener("click", ()=>{
      const p = readRow(tr);
      openModal("แก้ไขสินค้า", p);
    });

    tr.querySelector(".imgupdate").addEventListener("click", ()=>{
      const p = readRow(tr);
      // โหมดพิเศษ: อัปเดตรูปโดยใช้ POST /product (UPSERT) พร้อม image ใหม่ (ไม่แตะฟิลด์อื่น)
      openModal("อัปเดตรูปสินค้า", { ...p, onlyImage:true });
    });

    tr.querySelector(".delete").addEventListener("click", async ()=>{
      if (!confirm(`ลบสินค้า ${id}?`)) return;
      await deleteProduct(id);
      loadProducts();
    });
  });
}
// อ่านค่า row ปัจจุบัน (ใช้เติมฟอร์ม)
function readRow(tr){
  const sku = tr.dataset.id;
  const name = tr.querySelector("td:nth-child(3) > div").textContent.trim();
  const qty = Number(tr.querySelector(".qty").value||0);
  const brandCatTxt = tr.querySelector("td:nth-child(2) .mini").textContent; // "Nike • Running • men"
  const [brand, category, genderMaybe] = brandCatTxt.split("•").map(x=>x.trim());
  const isRec = tr.querySelector(".fa-star").classList.contains("fa-solid");
  const priceTxt = tr.querySelector(".price").textContent.replace(/[^\d.]/g,"");
  const price = Number(priceTxt||0);
  return {
    product_id: sku,
    name, quantity: qty,
    brand: brand==="-"?"":brand,
    category: category==="-"?"":category,
    gender: (genderMaybe||"").toLowerCase()||"",
    sell_price: price,
    recommended: isRec
  };
}

// ตัวกรองเฉพาะหน้า
function fillFilterDistinct(items){
  const cats = Array.from(new Set(items.map(x=>x.category).filter(Boolean))).sort();
  const brands = Array.from(new Set(items.map(x=>x.brand).filter(Boolean))).sort();
  fillSelect(els.fCat, cats, "หมวดหมู่ทั้งหมด");
  fillSelect(els.fBrand, brands, "แบรนด์ทั้งหมด");
}
function fillSelect(sel, arr, first){
  const v = sel.value;
  sel.innerHTML = `<option value="">${first}</option>` + arr.map(x=>`<option>${x}</option>`).join("");
  sel.value = v;
}

// ======= API calls =======
async function updateQuantity(product_id, quantity){
  await fetch(`${API}/product/${encodeURIComponent(product_id)}/quantity`, {
    method: "PATCH", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ quantity })
  });
}
async function toggleRecommended(product_id, recommended){
  await fetch(`${API}/products/${encodeURIComponent(product_id)}/recommended`, {
    method:"PATCH", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ recommended })
  });
}
async function deleteProduct(product_id){
  await fetch(`${API}/product/${encodeURIComponent(product_id)}`, { method:"DELETE" });
}
async function upsertProduct(formData){
  // ใช้ POST /product (UPSERT) — รองรับอัปโหลดรูปและไม่บังคับรูป
  await fetch(`${API}/product`, { method:"POST", body: formData });
}
async function updateProductJSON(product_id, payload){
  // ใช้ PUT /product/:id (JSON) — ตาม controller UpdateStock ที่คุณมี
  await fetch(`${API}/product/${encodeURIComponent(product_id)}`, {
    method:"PUT", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
}

// ======= Events =======
els.prevBtn.addEventListener("click", ()=>{ if(state.page>1){ state.page--; loadProducts(); }});
els.nextBtn.addEventListener("click", ()=>{ if(state.page*state.limit<state.total){ state.page++; loadProducts(); }});
els.refresh.addEventListener("click", ()=> loadProducts());

let typing; els.q.addEventListener("input", e=>{
  clearTimeout(typing);
  typing = setTimeout(()=>{ state.q = e.target.value.trim(); state.page=1; loadProducts(); }, 300);
});
[els.fCat, els.fBrand, els.fGender, els.fRec].forEach(sel=>{
  sel.addEventListener("change", ()=>{
    state.category = els.fCat.value; state.brand=els.fBrand.value;
    state.gender = els.fGender.value; state.recommended = els.fRec.value;
    state.page=1; loadProducts();
  });
});

// Submit Add/Edit
els.form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const mode = els.form.dataset.mode; // add | edit
  const onlyImage = els.form.dataset.onlyImage === "true";

  if (mode === "add"){
    const fd = new FormData(els.form);
    try{ await upsertProduct(fd); closeModal(); loadProducts(); }
    catch(err){ alert("บันทึกไม่สำเร็จ"); }
    return;
  }

  // edit
  const pid = els.form.dataset.originalId;
  const imgFile = els.form.image.files?.[0];

  // 1) ถ้ามีรูป -> ใช้ POST /product (UPSERT) เพื่ออัปเดตรูป (และค่าอื่น ๆ ถ้าต้องการ)
  if (imgFile){
    const fd = new FormData();
    ["product_id","name","brand","category","gender","quantity","cost_price","sell_price","original_price","recommended"].forEach(k=>{
      const v = els.form[k]?.value ?? "";
      if (v !== "") fd.append(k, v);
    });
    fd.set("product_id", pid); // คงรหัสเดิม
    fd.append("image", imgFile);
    try{ await upsertProduct(fd); } catch(e){ alert("อัปเดตรูปไม่สำเร็จ"); return; }
  }

  // 2) อัปเดตฟิลด์หลักผ่าน PUT /product/:id (JSON) — สอดรับกับ controller ปัจจุบัน
  const payload = {
    name: els.form.name.value,
    quantity: Number(els.form.quantity.value||0),
    cost_price: Number(els.form.cost_price.value||0),
    sell_price: Number(els.form.sell_price.value||0),
    recommended: els.form.recommended.value === "true",
  };
  try{
    await updateProductJSON(pid, payload);
    closeModal(); loadProducts();
  }catch(err){ alert("บันทึกไม่สำเร็จ"); }
});

// ปรับโหมดพิเศษสำหรับอัปเดตรูปเท่านั้น
// (เรียกตอนกดปุ่ม “เปลี่ยนรูป”)
const observer = new MutationObserver(()=>{
  const title = els.modalTitle.textContent || "";
  if (title.includes("อัปเดตรูปสินค้า")){
    els.form.dataset.mode = "edit";
    els.form.dataset.onlyImage = "true";
    // ทำให้กรอกเฉพาะรูปได้สะดวก (ส่วนอื่น ๆ ไม่บังคับ)
  }else{
    els.form.dataset.onlyImage = "false";
  }
});
observer.observe(els.modal, { attributes:true, attributeFilter:["class"] });

// Init
loadProducts();
</script>
</body>
</html>
